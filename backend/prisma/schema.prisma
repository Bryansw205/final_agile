generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ReceiptType {
  BOLETA
  FACTURA
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String
  role         String   @default("admin")
  createdAt    DateTime @default(now())
  createdLoans Loan[]   @relation("CreatedBy")
  payments     Payment[] @relation("RegisteredBy")
  cashSessions CashSession[] @relation("CashSessionUser")
}

model Client {
  id        Int      @id @default(autoincrement())
  dni       String   @unique
  firstName String
  lastName  String
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  loans     Loan[]
}

model Loan {
  id              Int      @id @default(autoincrement())
  clientId        Int
  client          Client   @relation(fields: [clientId], references: [id])
  createdByUserId Int
  createdBy       User     @relation("CreatedBy", fields: [createdByUserId], references: [id])
  principal       Decimal  @db.Decimal(18, 2)
  interestRate    Decimal  @db.Decimal(7, 4)
  termCount       Int
  startDate       DateTime
  createdAt       DateTime @default(now())
  schedules       PaymentSchedule[]
  payments        Payment[]
  lateFees        LateFee[]

  @@unique([clientId])
}

model PaymentSchedule {
  id                Int     @id @default(autoincrement())
  loanId            Int
  loan              Loan    @relation(fields: [loanId], references: [id])
  installmentNumber Int
  dueDate           DateTime
  installmentAmount Decimal @db.Decimal(18, 2)
  principalAmount   Decimal @db.Decimal(18, 2)
  interestAmount    Decimal @db.Decimal(18, 2)
  remainingBalance  Decimal @db.Decimal(18, 2)
  isPaid            Boolean @default(false)
  payments          Payment[]

  @@unique([loanId, installmentNumber])
}

enum PaymentMethod {
  EFECTIVO
  BILLETERA_DIGITAL
  TARJETA_DEBITO
  TARJETA
  YAPE
  PLIN
  FLOW
  OTRO
}

model Payment {
  id               Int           @id @default(autoincrement())
  loanId           Int
  loan             Loan          @relation(fields: [loanId], references: [id])
  installmentId    Int?
  installment      PaymentSchedule? @relation(fields: [installmentId], references: [id])
  registeredByUserId Int
  registeredBy     User          @relation("RegisteredBy", fields: [registeredByUserId], references: [id])
  amount           Decimal       @db.Decimal(18, 2)
  paymentMethod    PaymentMethod
  paymentDate      DateTime      @default(now())
  principalPaid    Decimal       @db.Decimal(18, 2)
  interestPaid     Decimal       @db.Decimal(18, 2)
  lateFeePaid      Decimal       @db.Decimal(18, 2) @default(0)
  roundingAdjustment Decimal     @db.Decimal(18, 2) @default(0)
  externalReference String?
  receiptNumber    String        @unique
  cashSessionId    Int?
  cashSession      CashSession?  @relation(fields: [cashSessionId], references: [id])
  createdAt        DateTime      @default(now())
  receiptType      ReceiptType?
  invoiceRuc       String?
  invoiceBusinessName String?
  invoiceAddress   String?

  @@index([loanId])
  @@index([paymentDate])
  @@index([cashSessionId])
  @@index([installmentId])
}

model LateFee {
  id          Int      @id @default(autoincrement())
  loanId      Int
  loan        Loan     @relation(fields: [loanId], references: [id])
  periodMonth Int
  periodYear  Int
  feeAmount   Decimal  @db.Decimal(18, 2)
  baseAmount  Decimal  @db.Decimal(18, 2)
  isPaid      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@unique([loanId, periodMonth, periodYear])
  @@index([loanId])
}

model CashSession {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation("CashSessionUser", fields: [userId], references: [id])
  openingBalance  Decimal  @db.Decimal(18, 2)
  closingBalance  Decimal? @db.Decimal(18, 2)
  physicalBalance Decimal? @db.Decimal(18, 2)
  difference      Decimal? @db.Decimal(18, 2)
  openedAt        DateTime @default(now())
  closedAt        DateTime?
  isClosed        Boolean  @default(false)
  payments        Payment[]

  @@index([userId])
  @@index([openedAt])
}
